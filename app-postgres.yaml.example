# DigitalOcean App Platform Spec with Managed PostgreSQL
# This version uses DO's managed database for persistence

name: mq-server
region: nyc

# Managed PostgreSQL Database
databases:
  - name: mq-db
    engine: PG
    version: "15"
    size: db-s-dev-database
    num_nodes: 1

services:
  - name: pocketbase
    dockerfile_path: Dockerfile.postgres
    source_dir: /
    github:
      branch: main
      deploy_on_push: true
      repo: YOUR_GITHUB_USERNAME/mq-server
    
    # Environment variables
    envs:
      # Database connection (automatically injected by DO)
      - key: DATABASE_URL
        scope: RUN_TIME
        value: ${mq-db.DATABASE_URL}
      
      # PocketBase settings
      - key: PB_ENCRYPTION_KEY
        value: "YOUR_32_CHAR_ENCRYPTION_KEY_HERE"
        type: SECRET
        scope: RUN_AND_BUILD_TIME
      
      # Apple Push Notification Service
      - key: APNS_KEY_ID
        value: "YOUR_APNS_KEY_ID"
        type: SECRET
        scope: RUN_TIME
      
      - key: APNS_TEAM_ID
        value: "YOUR_APPLE_TEAM_ID"
        type: SECRET
        scope: RUN_TIME
      
      - key: APNS_BUNDLE_ID
        value: "com.yourcompany.messagequest"
        scope: RUN_TIME
      
      - key: APNS_PRODUCTION
        value: "false"
        scope: RUN_TIME
      
      # AI Service (for suggested responses)
      - key: OPENAI_API_KEY
        value: "YOUR_OPENAI_KEY"
        type: SECRET
        scope: RUN_TIME
      
      # Admin credentials (set on first run)
      - key: ADMIN_EMAIL
        value: "admin@messagequest.com"
        scope: RUN_TIME
      
      - key: ADMIN_PASSWORD
        value: "CHANGE_THIS_STRONG_PASSWORD"
        type: SECRET
        scope: RUN_TIME
    
    # Instance configuration
    instance_size_slug: basic-xxs
    instance_count: 1
    
    # HTTP configuration
    http_port: 8090
    
    # Health check
    health_check:
      http_path: /api/health
      initial_delay_seconds: 30
      period_seconds: 10
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3
    
    # Public routes
    routes:
      - path: /
    
    # CORS settings for your iOS app
    cors:
      allow_origins:
        - prefix: "messagequest://"
        - prefix: "https://messagequest.com"
      allow_methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allow_headers:
        - Authorization
        - Content-Type

# Static site (optional - for web admin or landing page)
# static_sites:
#   - name: mq-landing
#     source_dir: /landing
#     index_document: index.html
#     error_document: 404.html
#     routes:
#       - path: /